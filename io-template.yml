# Copyright (c) 2021 Synopsys, Inc. All rights reserved worldwide.

variables:  
  ASSET_ID: $CI_PROJECT_PATH
  WORKFLOW_ENGINE_VERSION: "2021.12.3"
  POLARIS_PROJECT_NAME: $CI_PROJECT_NAME
  BLACKDUCK_PROJECT_NAME: $CI_PROJECT_NAME:$BLACKDUCK_PROJECT_VERSION 
  SCM_OWNER: $CI_PROJECT_NAMESPACE
  SCM_REPO_NAME: $CI_PROJECT_NAME
  SCM_BRANCH_NAME : $CI_COMMIT_BRANCH
  GITLAB_HOST_URL: $CI_SERVER_URL
  IS_SAST_ENABLED: "false"
  IS_SCA_ENABLED: "false"
  IS_DAST_ENABLED: "false"
  MANIFEST_TYPE: "yml"
    
IO:
   stage: io
   artifacts:
      reports:
          dotenv: scans.env
      paths:
          - $CI_PROJECT_DIR/scans.env
          - $CI_PROJECT_DIR/io_state.json
          - $CI_PROJECT_DIR/io_client-${SYNOPSYS_IO_Workflow_Engine_Version}
   cache:
      key: io_${SYNOPSYS_IO_Workflow_Engine_Version}
      paths:
        - $CI_PROJECT_DIR/io_client-${SYNOPSYS_IO_Workflow_Engine_Version}
   script:
       - >
           if [ ! -d 'io_client-${SYNOPSYS_IO_Workflow_Engine_Version}' ]; then
              wget http://artifactory.internal.synopsys.com/artifactory/clops-local/clops.sig.synopsys.com/io_client/${SYNOPSYS_IO_Workflow_Engine_Version}/io_client-${SYNOPSYS_IO_Workflow_Engine_Version}.zip
              unzip -o io_client-${SYNOPSYS_IO_Workflow_Engine_Version}.zip
           fi 
       - chmod +x io_client-${SYNOPSYS_IO_Workflow_Engine_Version}/${SYNOPSYS_IO_Os_Type}/bin/io
       - io_client-${SYNOPSYS_IO_Workflow_Engine_Version}/${SYNOPSYS_IO_Os_Type}/bin/io --stage io
       - IS_SAST_ENABLED=$(jq -r '.Data.Prescription.Security.Activities.Sast.Enabled' io_state.json)
       - IS_SCA_ENABLED=$(jq -r '.Data.Prescription.Security.Activities.Sca.Enabled' io_state.json)
       - |
        if [ -z "$IS_SAST_ENABLED" ]; then
          IS_SAST_ENABLED=false
        fi

        if [ -z "$IS_SCA_ENABLED" ]; then
          IS_SCA_ENABLED=false
        fi
       - echo "IS_SAST_ENABLED=${IS_SAST_ENABLED}" >> scans.env
       - echo "IS_SCA_ENABLED=${IS_SCA_ENABLED}" >> scans.env
       - rm -rf synopsys-io.yml
       - rm -rf synopsys-io.json       
       - |
        echo "================================== IO Prescription ======================================="
        echo "Is SAST Enabled - ${IS_SAST_ENABLED}"
        echo "Is SCA Enabled - ${IS_SCA_ENABLED}"
        if [ $PERSONA == "devsecops" ]; then
            echo "==================================== IO Risk Score ======================================="
            echo "Buisness Criticality Score - $(jq -r '.Data.Prescription.RiskScore.BusinessCriticalityScore' io_state.json)"
            echo "Data Class Score - $(jq -r 'Data.Prescription.RiskScore.DataClassScore' io_state.json)"
            echo "Access Score - $(jq -r 'Data.Prescription.RiskScore.AccessScore' io_state.json)"
            echo "Open Vulnerability Score - $(jq -r '.Data.Prescription.RiskScore.OpenVulnerabilityScore' io_state.json)"
            echo "Change Significance Score - $(jq -r 'Data.Prescription.RiskScore.ChangeSignificanceScore' io_state.json)"
            export bizScore=$(jq -r '.Data.Prescription.RiskScore.BusinessCriticalityScore' io_state.json | cut -d'/' -f2)
            export dataScore=$(jq -r '.Data.Prescription.RiskScore.DataClassScore' io_state.json | cut -d'/' -f2)
            export accessScore=$(jq -r '.Data.Prescription.RiskScore.AccessScore' io_state.json | cut -d'/' -f2)
            export vulnScore=$(jq -r '.Data.Prescription.RiskScore.OpenVulnerabilityScore' io_state.json | cut -d'/' -f2)
            export changeScore=$(jq -r '.Data.Prescription.RiskScore.ChangeSignificanceScore' io_state.json | cut -d'/' -f2)
            echo -n "Total Score - " && echo "$bizScore + $dataScore + $accessScore + $vulnScore + $changeScore" | bc
        fi    

        
IO_WORKFLOWENGINE:
   stage: workflowengine
   artifacts:
        paths:
            - $CI_PROJECT_DIR/*.sarif.json
   script:
       - >
           if [ ! -d 'io_client-${SYNOPSYS_IO_Workflow_Engine_Version}' ]; then
              wget http://artifactory.internal.synopsys.com/artifactory/clops-local/clops.sig.synopsys.com/io_client/${SYNOPSYS_IO_Workflow_Engine_Version}/io_client-${SYNOPSYS_IO_Workflow_Engine_Version}.zip
              unzip -o io_client-${SYNOPSYS_IO_Workflow_Engine_Version}.zip
           fi  
       - chmod +x io_client-${SYNOPSYS_IO_Workflow_Engine_Version}/${SYNOPSYS_IO_Os_Type}/bin/io
       - export SYNOPSYS_IO_Polaris_Enabled=true
       - io_client-${SYNOPSYS_IO_Workflow_Engine_Version}/${SYNOPSYS_IO_Os_Type}/bin/io --stage workflow --state io_state.json
       - |
        echo "========================== IO WorkflowEngine Summary ============================" 
        echo "Breaker Status - $(jq -r '.breaker.status' wf-output.json)"    
       - rm -rf synopsys-io.yml
       - rm -rf synopsys-io.json
